name: CI

on:
  push:
  pull_request:

jobs:
  lint-and-dryrun:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Show AWS script header (debug)
        shell: pwsh
        run: |
          Write-Host "=== aws/ec2_start_stop.ps1 (first 40 lines) ==="
          Get-Content ./aws/ec2_start_stop.ps1 -TotalCount 40
          Write-Host "=== PowerShell version ==="
          $PSVersionTable

      - name: Show Azure script header (debug)
        shell: pwsh
        run: |
          Write-Host "=== azure/vm_start_stop.ps1 (first 40 lines) ==="
          Get-Content ./azure/vm_start_stop.ps1 -TotalCount 40

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
          Invoke-ScriptAnalyzer -Path . -Recurse -Severity Warning -ReportSummary

      - name: Dry-run AWS EC2 script (argument parsing only)
        shell: pwsh
        run: |
          pwsh -NoProfile -File ./aws/ec2_start_stop.ps1 -Action Start -TagKey Role -TagValue Web -Region us-east-1 -DryRun

      - name: Dry-run Azure VM script (argument parsing only)
        shell: pwsh
        run: |
          pwsh -NoProfile -File ./azure/vm_start_stop.ps1 -Action Stop -TagName Role -TagValue Web -ResourceGroup rg-sandbox -DryRun
